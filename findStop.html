<!DOCTYPE html>
<html>
	<head>
		<!-- Meta tags -->
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>Ready Set Go | Find A Stop</title>

		<!-- CSS -->
		<link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.css">
        <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" type="text/css" href="stylesheet.css">
	</head>
	
	<body>
		<div class="navbar navbar-inverse navbar-static-top">
			<div class="container">
				<p class="navbar-brand">Find a <span class="titleEmphasis">Stop</span></p>
			</div>
		</div>

		<!-- Location Input -->
		<div class="container" id="location-input">
			<div class="input-group">                
				<input type="text" id="destination" class="form-control" placeholder="Enter Desintation">
				<span class="input-group-btn">
					<button class="btn btn-default" id="search" type="button">Find closest stop</button>
				</span>
			</div>
		</div>

        <!-- Map -->
        <div id="findStopMap">
            <div class="ui-content" id="map-canvas"></div>
        </div>

		<!-- Stop Information -->
		<div class="container finalContent">
			<div class="row">
				<div class="col-xs-7">
					<h1>Stop Information</h1>
					<p>Information about the stop would go here.</p>
					<!-- Bus Route Numbers -->
					<button class="label-warning" id="b11">11</button>
					<button class="label-warning" id="b17">17</button>
					<button class="label-warning" id="b42">42</button>
					<button class="label-warning" id="b52">52</button>
					<button class="label-warning" id="b57">57</button>
				</div>
			</div>
		</div>

		<!-- Footer -->
		<div class="navbar navbar-inverse navbar-fixed-bottom">
			<div class="container">
				<a href="index.html">
					<p class="navbar-text"><span class="titleEmphasis"><< HOME</span></p>
				</a>
			</div>
		</div>

		<!-- JS -->
		<script src="js/jquery-1.11.3.min.js"></script>
		<script src="bootstrap/js/bootstrap.js"></script>
        <script src="https://maps-api-ssl.google.com/maps/api/js"></script>
      
        <script type="text/javascript">
            // TODO Make into a separate file
            
            var lat, lng; // Latitude and Longitude of the user
            
            $(document).ready(function() {
                // Helper function to deal with button events.
                $("button").click(function(event) {
                    switch(event.target.id){
                        case "search":
                            search();
                            break;
                        case "useFromLocation":
                            break;
                        case "b11":
                            drawPath(11);
                            break;
                        case "b17":
                            drawPath(17);
                            break;
                        case "b42":
                            drawPath(42);
                            break;
                        case "b52":
                            drawPath(52);
                            break;
                        case "b57":
                            drawPath(57);                            
                            break;
                        default:
                            alert("No button ID found for: "+event.target.id);
                    }
                });

                /**
                 * Searches for the suitable bus stop to get on and off at
                 */
                function search(){
                    // TODO Make search work basic brute force version
                    // TODO Checks to make sure input is valid
                    // TODO Move map so that everything is in the view
//                    if(typeof lat != "undefined" || typeof lng != "undefined"){
                        var destLat, destLng;                        
                        var address = document.getElementById("destination").value;
                        
                        codeAddress(address, function(result) {
                            // TODO remove previous markers
                            markers[0] = ( marker = new google.maps.Marker({
                                  position: result,
                                  map: map,
                                  title: 'Destination'
                            }));
                        });
//                    } else {
//                        alert("Please enter a destination");   
//                    }
                };
                
                /**
                 * Centres map on users location once the map is created
                 */
                function useLocation(){
                    // TODO add a marker for user
                    // TODO keep moving map to keep user centred
                    if(navigator.geolocation){                            
                        navigator.geolocation.getCurrentPosition (function (pos) {
                            lat = pos.coords.latitude;
                            lng = pos.coords.longitude;
                            //alert("Lat: "+lat+" Long: " + lng);
                            
                            map.setCenter(new google.maps.LatLng(lat, lng));
                            
                        }, function(){
                            noGeolocation(true);   
                        }, {maximumAge: 500000, enableHighAccuracy:true, timeout: 6000});
                    };
                };

                /**
                 * What to do if geolocation isn't available
                 */
                function noGeolocation(geoError){
                    if(geoError){
                        alert("Geolocation service failed");
                    } else {
                        alert("Browser/device doesn't support geolocation");
                    }

                    addInputLocation();
                };
                
                /**
                 * Adds the dialogue box for a user to enter their position when geolocation isn't available
                 */
                function addInputLocation(){
                    if(document.getElementById("from-input") == null){
                        var fromInput = document.createElement("div");
                        fromInput.setAttribute("id", "from-input");
                        fromInput.setAttribute("class", "input-group");
                        fromInput.innerHTML = '<input type="text" class="form-control" placeholder="Where are you?"><span class="input-group-btn"><button class="btn btn-default" id="useFromLocation" type="button">Use this location</button></span>';
                        $("#location-input").prepend(fromInput);
                    } 
                }
                
                /**
                 * Draws the given route number's path onto the map
                 */
                function drawPath(routeNumber){
                    //TODO remove previous paths from the map
                    var url = "https://ready-set-go.herokuapp.com/path/"+routeNumber;
                    $.get(url, function(rawPath) {
                        var pathData = [];
                        
                        // Get route information & iterate over into array
                        for (var i = 0; i < rawPath.length; i++){
                            pathData[i] = new google.maps.LatLng(rawPath[i].shape_pt_lat, rawPath[i].shape_pt_lon);
                            var busPath = new google.maps.Polyline({
                                path: pathData 
                            });
                            busPath.setMap(map);
                        }
                    }, 'json');
                };
                
                /** 
                 * Turns the inputAddress into a geolocation
                 * inputid is the users entered string
                 */
                function codeAddress(inputAddress, callback) {
                    // TODO Create a preference/focus for Wellington area
                    // TODO Create a better dialogue box for failure
                    geocoder.geocode( { 'address': inputAddress}, function(results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {
                            callback( results[0].geometry.location);
                        } else {
                            alert("Geocode was not successful for the following reason: " + status);
                        }
                    });
                }

                // ******* Map initialisation ******
                var map;
                var geocoder;
                var markers = [];
                function initialise() {
                    var mapOptions = {
                        zoom: 14,
                        scrollwheel: false,
                        navigationControl: false,
                        mapTypeControl: false,
                        scaleControl: false,
                        draggable: false,
                        disableDefaultUI: true,
                        center: new google.maps.LatLng(-41.3, 174.783),
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    };
                    map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
                    geocoder = new google.maps.Geocoder();
                }
                
                google.maps.event.addDomListener(window, 'load', initialise);
                useLocation();
            });
        </script>
	</body>
</html>